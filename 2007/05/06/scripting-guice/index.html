<!DOCTYPE html><html><head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Scripting Guice</title>
    <link rel="stylesheet" type="text/css" href="/style.css"/>
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml"/>
  </head>
  <body>
    <div class="body">
      <div class="header">
        <div class="title">
          <a href="/">Robbie&#39;s Garbage, Collected.</a>
        </div>
        <input type="checkbox" id="theme-toggle" aria-label="Toggle theme"/>
        <label for="theme-toggle" class="theme-toggle-label"></label>
      </div>
      <div class="blog">
        <h1>Scripting Guice</h1>
        <div class="date">May 6, 2007</div>
        <div class="entry">

        <p>I really like <a href="http://code.google.com/p/google-guice/">Guice</a>, a Java 5 style Dependency Injection framework by the bright guys at Google.</p>
<p>People who are used to <a href="http://static.springframework.org/spring/docs/2.0.x/reference/beans.html#beans-factory-metadata">Spring&#39;s DI config</a> often complain that they don&#39;t like the &#34;compiled configuration&#34; thing (Java Modules) Guice has. In Spring, all your wiring is usually done in XML. So on one side you have compiled Java Guice Modules, a more natural programming model for Java developers, and on the other side you have XML configuration, nicely externalized.  And yes, I know the Spring guys plan on having a Java version of their configuration syntax, but it looks just like the XML, so I don&#39;t see any real advantages there.</p>
<p>Anyway, for the Spring users who want to try out Guice, you could externalize your configuration to a properties file, and load it from that. Or whatever format you&#39;re willing to use. Heck, you could even write some code that parses a Spring config file and translates it into a Guice Module.</p>
<p>But here&#39;s another idea: what about using a scripting language for all your object wiring needs? Why create a configuration file if you could use the highly readable Guice Binder syntax? Well, I tried it, and it  works great :-)</p>
<p>Let&#39;s start with an example. This one&#39;s about me drinking some beer. So here&#39;s me:</p>
<pre><code>public class Robbie {
    private Beer myBeer;

    @Inject
    public Robbie(@Strong Beer freshBeer) {
        this.myBeer = freshBeer;
    }
    public void startDrinking() {
        myBeer.drink();
    }
}
</code></pre>
<p>And here&#39;s some beer:</p>
<pre><code>public interface Beer {
    void drink();
}
public class Duvel implements Beer {
    public void drink() {
        System.out.println(&#34;Duvel!&#34;);
    }
}
public class StellaArtois implements Beer {
    public void drink() {
        System.out.println(&#34;Stella Artois&#34;);
    }
}
</code></pre>
<p>The <code>@Strong</code> annotation basically means I&#39;d like a strong beer, not just some water with taste. So I created a Guice <code>BindingAnnotation</code> for that, and expressed the binding in a module:</p>
<pre><code>@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.FIELD, ElementType.PARAMETER})
@BindingAnnotation
public @interface Strong {}
</code></pre>
<pre><code>public class BeerModule implements Module {
    public void configure(Binder binder) {
        binder.bind(Beer.class).to(StellaArtois.class);
        binder.bind(Beer.class).annotatedWith(Strong.class).to(Duvel.class);
        System.out.println(&#34;Configured using Java implemented Guice Module!&#34;);
    }
}
</code></pre>
<p>So everyone is getting regular beers, unless they specify they want some stronger beer. You could run this code like this:</p>
<pre><code>public class StartGuice {
    public static void main(String[] args) {
        Injector i = Guice.createInjector(Stage.DEVELOPMENT, new BeerModule());
        Robbie robbie = i.getInstance(Robbie.class);
        System.out.print(&#34;Robbie starts drinking: &#34;);
        robbie.startDrinking();
    }
}
</code></pre>
<p>This prints:</p>
<pre><code>Configured using Java implemented Guice Module!
Robbie starts drinking: Duvel!
</code></pre>
<p>Hmm... tasty. Now, let&#39;s get us some scripting. I&#39;ll thankfully use the new <a href="https://java.net/projects/scripting/">Java 6 scripting support</a>, you could probably use the <a href="http://jakarta.apache.org/bsf/">BSF</a> as well. Also, I&#39;ll use <a href="http://www.jython.org">Jython</a> for scripting, a Java Python implementation. So I throw in <code>jython.jar</code>, <code>jython-engine.jar</code> (from the scripting site), <code>aopalliance.jar</code> next to the <code>guice.jar</code>. By the way, if you want to know how all this scripting support stuff works, check out <a href="http://jroller.com/page/mom?entry=tutorial_running_ruby_using_the">Jurgen&#39;s excellent introduction</a>.</p>
<p>Anyway, let&#39;s try binding our dependencies in Python. Create a file called <code>BeerBinder.py</code> that looks like this:</p>
<pre><code>import java
from scriptguice import *

    def configure(binder):
        binder.bind(Beer).to(StellaArtois);
        binder.bind(Beer).annotatedWith(Strong).to(Duvel);
        print &#34;Configured Guice using Python method!&#34;
</code></pre>
<p>Then we add some scripting magic to our Guice Module, so that we delegate the configure call to the Python script:</p>
<pre><code>public class BeerModule implements Module {
    public void configure(Binder binder) {
        ScriptEngineManager mgr = new ScriptEngineManager();
        ScriptEngine python = mgr.getEngineByName(&#34;python&#34;);
        Reader reader = ReadUtil.getReaderForClassPathResource(&#34;scriptguice/pythonmethod/BeerBinder.py&#34;);
        try {
            python.eval(reader);
            Invocable invocablePython = (Invocable) python;
            invocablePython.invokeFunction(&#34;configure&#34;, binder);
        } catch (ScriptException e) {
            throw new RuntimeException(e);
        } catch (NoSuchMethodException e) {
            throw new RuntimeException(e);
        }
    }
}
</code></pre>
<p>If we run <code>StartGuice</code> again, the output now looks like:</p>
<pre><code>Configured Guice using Python method!
Robbie starts drinking: Duvel!
</code></pre>
<p>Great, it works! Now let&#39;s take it one step further and get rid of the ugly Java / Python mix. Python all the way! Create a file called <code>BeerModule.py</code>:</p>
<pre><code>import java
from scriptguice import *
from com.google.inject import *

class BeerModule(Module):
    def configure(self, binder):
        binder.bind(Beer).to(StellaArtois);
        binder.bind(Beer).annotatedWith(Strong).to(Duvel);
        print &#34;Configured using Python implemented Guice Module!&#34;

# Factory method that returns new BeerModule
def getBeerModule():
    return BeerModule()
</code></pre>
<p>So we created a class called <code>BeerModule</code>, and subclassed the Java class <code>com.google.inject.Module</code>. Jython really starts to shine here. Let&#39;s do some magic to get the thing back in Java:</p>
<pre><code>public class StartGuice {
    public static Module getPythonBeerModule() {
        ScriptEngineManager mgr = new ScriptEngineManager();
        ScriptEngine python = mgr.getEngineByName(&#34;python&#34;);
        try {
            Reader reader = ReadUtil.getReaderForClassPathResource(&#34;scriptguice/pythonclass/BeerModule.py&#34;);
            python.eval(reader);
            Invocable invocablePython = (Invocable)python;
            return (Module)invocablePython.invokeFunction(&#34;getBeerModule&#34;);
        } catch (ScriptException e) {
            throw new RuntimeException(e);
        } catch (NoSuchMethodException e) {
            throw new RuntimeException(e);
        }
    }

    public static void main(String[] args) {
        Injector i = Guice.createInjector(Stage.DEVELOPMENT, getPythonBeerModule());
        Robbie robbie = i.getInstance(Robbie.class);
        System.out.print(&#34;Robbie starts drinking: &#34;);
        robbie.startDrinking();
    }
}
</code></pre>
<p>It&#39;s been a long time since my last beer, so here we go:</p>
<pre><code>Configured using Python implemented Guice Module!
Robbie starts drinking: Duvel!
</code></pre>
<p>Man, how cool is this? Now we have defined the entire Guice module in Python code, and I got drunk in the process. Life just doesn&#39;t get any better, does it ;-)</p>
<p>Now you could take it even further and return an array of Modules or what not, which is probably what you want in a real world app. Oh and one final note: don&#39;t just copy paste this code. Close the Reader and stuff. I&#39;m just being lazy for the sake of the example.</p>
<p>Thanks to <a href="https://twitter.com/crazybob">Bob Lee</a> and <a href="http://smallwig.blogspot.com/">Kevin Bourrillion</a> for creating Guice, the coolest DI framework on the planet.</p>
</div>
        <div class="footer">
          <em>Liking this? Follow me: <a href="/rss.xml">RSS</a>, <a href="https://bsky.app/profile/robbiev.uk">Bluesky</a>, <a href="https://mastodon.social/@robbiev">Mastodon</a>.</em>
        </div>
      </div>
    </div>
  

</body></html>